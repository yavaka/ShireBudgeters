@page "/admin/lead-magnets"

@using Microsoft.AspNetCore.Authorization
@using ShireBudgeters.BL.Services.Category
@using ShireBudgeters.BL.Services.Identity
@using ShireBudgeters.BL.Services.LeadMagnet
@using ShireBudgeters.Components.Pages.Admin.LeadMagnet.Components
@using ShireBudgeters.Common.DTOs
@using static ShireBudgeters.Common.DTOs.AuthDTOs

@layout AdminLayout
@attribute [Authorize]
@rendermode InteractiveServer
@inject ICategoryService CategoryService
@inject ILeadMagnetService LeadMagnetService
@inject IIdentityService IdentityService
@inject DialogService DialogService
@inject NavigationManager NavigationManager

<PageTitle>Lead Magnets Management</PageTitle>

<RadzenStack Orientation="Orientation.Vertical" Gap="1.5rem" class="rz-p-4">
    <RadzenText Text="Lead Magnets Management"
                TextStyle="TextStyle.H3"
                class="rz-mb-2" />

    <LeadMagnetActionBar OnCreate="@HandleCreate"
                         OnSearch="@HandleSearch" />

    @if (_isLoading)
    {
        <RadzenProgressBarCircular ShowValue="false" />
    }
    else if (!_allCategories.Any())
    {
        <RadzenStack Orientation="Orientation.Vertical" Gap="0.75rem" class="rz-p-4 rz-text-center">
            <RadzenText Text="No categories found. Create a category first to start adding lead magnets."
                        TextStyle="TextStyle.Body1"
                        class="rz-text-secondary" />
            <RadzenButton Text="Go to Categories"
                          Icon="category"
                          ButtonStyle="ButtonStyle.Primary"
                          Click="@(() => NavigationManager.NavigateTo("/admin/categories"))" />
        </RadzenStack>
    }
    else if (!_allLeadMagnets.Any())
    {
        <RadzenText Text="No lead magnets found. Create your first lead magnet to get started."
                    TextStyle="TextStyle.Body1"
                    class="rz-text-secondary rz-text-center rz-p-4" />
    }
    else
    {
        <RadzenRow Gap="1.5rem">
            @foreach (var leadMagnet in _filteredLeadMagnets)
            {
                <RadzenColumn Size="12" SizeMD="6" SizeLG="4">
                    <RadzenCard class="rz-shadow-2">
                        <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">
                            @if (_categoriesById.TryGetValue(leadMagnet.CategoryId, out var category) &&
                                 !string.IsNullOrWhiteSpace(category.Color))
                            {
                                <div style="height: 4px; background-color: @category.Color; margin: -16px -16px 16px -16px;"></div>
                            }

                            <RadzenText Text="@leadMagnet.Title"
                                        TextStyle="TextStyle.H6"
                                        class="rz-fw-bold" />

                            @if (_categoriesById.TryGetValue(leadMagnet.CategoryId, out category))
                            {
                                <RadzenText Text="@($"Category: {category.Name}")"
                                            TextStyle="TextStyle.Body2"
                                            class="rz-text-secondary" />
                            }

                            @if (!string.IsNullOrWhiteSpace(leadMagnet.FormActionUrl))
                            {
                                <RadzenText Text="@($"Form Action: {leadMagnet.FormActionUrl}")"
                                            TextStyle="TextStyle.Body2"
                                            class="rz-text-secondary" />
                            }

                            @if (!string.IsNullOrWhiteSpace(leadMagnet.DownloadFileUrl))
                            {
                                <RadzenText Text="@($"Download: {leadMagnet.DownloadFileUrl}")"
                                            TextStyle="TextStyle.Body2"
                                            class="rz-text-secondary" />
                            }

                            <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" class="rz-mt-2">
                                <RadzenBadge Text="@(leadMagnet.IsActive ? "Active" : "Inactive")"
                                             BadgeStyle="@(leadMagnet.IsActive ? BadgeStyle.Success : BadgeStyle.Danger)" />
                            </RadzenStack>

                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" class="rz-mt-2">
                                <RadzenButton Icon="edit"
                                              ButtonStyle="ButtonStyle.Light"
                                              Size="ButtonSize.Small"
                                              Click="@(() => HandleEdit(leadMagnet))" />
                                <RadzenButton Icon="delete"
                                              ButtonStyle="ButtonStyle.Light"
                                              Size="ButtonSize.Small"
                                              Click="@(() => HandleDelete(leadMagnet))" />
                            </RadzenStack>
                        </RadzenStack>
                    </RadzenCard>
                </RadzenColumn>
            }
        </RadzenRow>
    }
</RadzenStack>

@code {
    private IEnumerable<LeadMagnetDTO> _allLeadMagnets = new List<LeadMagnetDTO>();
    private IEnumerable<LeadMagnetDTO> _filteredLeadMagnets = new List<LeadMagnetDTO>();
    private IEnumerable<CategoryDTO> _allCategories = new List<CategoryDTO>();
    private Dictionary<int, CategoryDTO> _categoriesById = new();

    private bool _isLoading = true;
    private bool _hasLoadedData = false;

    private UserInfoDTO? _currentUser;

    protected override async Task OnInitializedAsync()
    {
        _currentUser = await IdentityService.GetCurrentUserAsync();
        if (_currentUser is null)
        {
            NavigationManager.NavigateTo("/Account/Login", forceLoad: true);
            return;
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (_currentUser is not null && !_hasLoadedData)
        {
            await LoadDataAsync();
            _hasLoadedData = true; // Prevents infinite refresh loops
        }
    }

    private async Task LoadDataAsync()
    {
        if (_currentUser is null)
        {
            return;
        }

        _isLoading = true;

        _allCategories = await CategoryService.GetByUserIdAsync(_currentUser.Id);
        _categoriesById = _allCategories.ToDictionary(c => c.Id);

        _allLeadMagnets = await LeadMagnetService.GetByUserIdAsync(_currentUser.Id);
        _filteredLeadMagnets = _allLeadMagnets;

        _isLoading = false;
    }

    private async Task HandleCreate()
    {
        if (_currentUser is null)
        {
            return;
        }

        if (!_allCategories.Any(c => c.IsActive))
        {
            await DialogService.Alert("You need at least one active category to create a lead magnet.", "No Active Categories", new AlertOptions { OkButtonText = "OK" });
            return;
        }

        var result = await DialogService.OpenAsync<CreateLeadMagnetDialog>("Create Lead Magnet",
            new Dictionary<string, object?>
            {
                { "UserId", _currentUser.Id },
                { "AvailableCategories", _allCategories }
            },
            new DialogOptions
            {
                Width = "700px",
                Resizable = true,
                Draggable = true
            });

        if (result is LeadMagnetDTO createdLeadMagnet)
        {
            await LoadDataAsync();
            StateHasChanged();
        }
    }

    private void HandleSearch(string searchValue)
    {
        _filteredLeadMagnets = _allLeadMagnets.Where(lm =>
            string.IsNullOrWhiteSpace(searchValue) ||
            lm.Title.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ||
            (lm.FormActionUrl?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false) ||
            (lm.DownloadFileUrl?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false) ||
            (_categoriesById.TryGetValue(lm.CategoryId, out var category) &&
             category.Name.Contains(searchValue, StringComparison.OrdinalIgnoreCase)))
            .ToList();

        StateHasChanged();
    }

    private async Task HandleEdit(LeadMagnetDTO leadMagnet)
    {
        if (_currentUser is null)
        {
            return;
        }

        var result = await DialogService.OpenAsync<EditLeadMagnetDialog>("Edit Lead Magnet",
            new Dictionary<string, object?>
            {
                { "UserId", _currentUser.Id },
                { "LeadMagnet", leadMagnet },
                { "AvailableCategories", _allCategories }
            },
            new DialogOptions
            {
                Width = "700px",
                Resizable = true,
                Draggable = true
            });

        if (result is LeadMagnetDTO updatedLeadMagnet)
        {
            await LoadDataAsync();
            StateHasChanged();
        }
    }

    private async Task HandleDelete(LeadMagnetDTO leadMagnet)
    {
        if (_currentUser is null)
        {
            return;
        }

        var confirmed = await DialogService.Confirm(
            $"Are you sure you want to permanently delete '{leadMagnet.Title}'? This action cannot be undone.",
            "Delete Lead Magnet",
            new ConfirmOptions { OkButtonText = "Delete", CancelButtonText = "Cancel" });

        if (confirmed != true)
        {
            return;
        }

        try
        {
            await LeadMagnetService.DeleteAsync(leadMagnet.Id, _currentUser.Id);
            await LoadDataAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await DialogService.Alert(ex.Message, "Error Deleting Lead Magnet", new AlertOptions { OkButtonText = "OK" });
        }
    }
}
