@rendermode InteractiveServer
@implements IDisposable
@using ShireBudgeters.Configurations
@using ShireBudgeters.Common.DTOs

@inject NavigationManager NavManager
@inject IConfiguration Configuration
@inject IServiceScopeFactory ServiceScopeFactory

<header class="public-header">
    <div class="public-header-inner">
        @* A. Logo — top-left, links to Homepage *@
        <a href="/" class="public-logo" aria-label="ShireBudgeters Home">
            <span class="public-logo-text">ShireBudgeters</span>
        </a>

        @* B. Primary Menu — horizontal nav with dropdowns (from appsettings + active categories) *@
        <nav class="public-nav" aria-label="Primary navigation">
            <ul class="public-nav-list">
                <li class="public-nav-item">
                    <button type="button"
                            class="public-nav-link public-nav-trigger @(IsHome ? "active" : "")"
                            @onclick="@(() => NavManager.NavigateTo("/"))"
                            aria-current="@(IsHome ? "page" : null)">
                        Home
                    </button>
                </li>
                @foreach (var item in _navItems)
                {
                    <li class="public-nav-item public-nav-dropdown">
                        <button type="button" class="public-nav-link public-nav-trigger" @onclick="@(() => ToggleDropdown(item.Slug))" aria-expanded="@(_openDropdown == item.Slug)" aria-haspopup="true">
                            @item.Name <span class="dropdown-chevron">▼</span>
                        </button>
                        <div class="public-nav-dropdown-menu @(_openDropdown == item.Slug ? "open" : "")" id="dropdown-@item.Slug">
                            <a href="/@item.Slug" class="public-nav-dropdown-item">All @item.Name</a>
                            @foreach (var child in item.Children)
                            {
                                <a href="/@child.Slug" class="public-nav-dropdown-item">@child.Name</a>
                            }
                        </div>
                    </li>
                }
            </ul>
        </nav>

        @* C. Search icon — opens full-screen/modal search *@
        <button type="button" class="public-search-trigger" @onclick="OpenSearch" aria-label="Open search">
            <RadzenIcon Icon="search" />
        </button>
    </div>
</header>

@* Dropdown overlay — close dropdown when clicking outside *@
@if (_openDropdown is not null)
{
    <div class="public-nav-dropdown-backdrop" @onclick="@(() => ToggleDropdown(_openDropdown!))" aria-hidden="true"></div>
}

@* Search overlay — full-screen modal *@
@if (_searchOpen)
{
    <SearchModal OnClose="CloseSearch" />
}

@code {
    private string? _openDropdown;
    private bool _searchOpen;
    private List<NavCategoryItem> _navItems = new();

    private bool IsHome => NavManager.ToBaseRelativePath(NavManager.Uri).Trim('/').Length == 0;

    private void ToggleDropdown(string id) => _openDropdown = _openDropdown == id ? null : id;

    private void OpenSearch() => _searchOpen = true;
    private void CloseSearch() => _searchOpen = false;

    protected override async Task OnInitializedAsync()
    {
        NavManager.LocationChanged += OnLocationChanged;

        var options = Configuration.GetSection("Navbar").Get<NavbarOptions>();
        var slugs = options?.CategorySlugs ?? new List<string>();
        if (slugs.Count == 0)
            return;

        await using (var scope = ServiceScopeFactory.CreateAsyncScope())
        {
            var categoryService = scope.ServiceProvider.GetRequiredService<ShireBudgeters.BL.Services.Category.ICategoryService>();
            var allActive = (await categoryService.GetAllActiveAsync()).ToList();
            var bySlug = allActive.Where(c => !string.IsNullOrWhiteSpace(c.Slug)).ToDictionary(c => c.Slug!, c => c);
            _navItems = new List<NavCategoryItem>();
            foreach (var slug in slugs)
            {
                if (string.IsNullOrWhiteSpace(slug) || !bySlug.TryGetValue(slug.Trim(), out var cat))
                    continue;
                if (cat.ParentCategoryId.HasValue)
                    continue;
                var children = allActive.Where(c => c.ParentCategoryId == cat.Id).OrderBy(c => c.Name).ToList();
                _navItems.Add(new NavCategoryItem(cat.Slug!, cat.Name, children.Select(c => new NavCategoryItem(c.Slug ?? "", c.Name, new List<NavCategoryItem>())).ToList()));
            }
        }
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        _openDropdown = null;
        StateHasChanged();
    }

    public void Dispose() => NavManager.LocationChanged -= OnLocationChanged;

    private sealed record NavCategoryItem(string Slug, string Name, List<NavCategoryItem> Children);
}
